---

    import '../styles/global.css';
    import { getCollection } from "astro:content";

    const familias = await getCollection("familias");
    familias.sort((a, b) => a.data.title.localeCompare(b.data.title, "es"));
---

<header id="site-header" class="fixed top-0 inset-x-0 z-50 transition-transform duration-300 bg-gray-50 dark:text-white dark:bg-gray-900">
    <nav class="mx-auto max-w-7xl px-4 h-14 md:h-16 lg:h-20 flex items-center justify-between">
        <a href="/" class="inline-flex items-center shrink-0" aria-label="Inicio">

            <img class="block dark:hidden w-auto h-14 md:h-16 lg:h-18" decoding="async" loading="eager" src="/NVMlogo.svg" alt="NVM Logo"/>
            <img class="dark:block hidden w-auto h-14 md:h-16 lg:h-18" decoding="async" loading="eager" src="/NVMlogoblanco.svg" alt="NVM Logo" />

        </a>

        <ul class="hidden md:flex items-center space-x-6 text-sm font-medium">
            <li><a href="/" class="hover:text-amarillonvm">Inicio</a></li>
            <li><a href="#servicios" class="hover:text-amarillonvm">Servicios</a></li>
            <li><a href="#quienes-somos" class="hover:text-amarillonvm">Quiénes somos</a></li>
            <li class="relative">
                <button
                        id="desktop-familias-btn"
                        type="button"
                        aria-expanded="false"
                        aria-controls="desktop-familias-menu"
                        class="inline-flex items-center gap-1 rounded-full px-3 py-1.5
                        hover:bg-black/5 dark:hover:bg-white/10 hover:text-amarillonvm transition"
                >
                    Portafolio
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>

                <div
                        id="desktop-familias-menu"
                        class="hidden absolute right-0 top-full mt-2 w-72 rounded-2xl shadow-xl border
                           bg-white/95 dark:bg-gray-900/95 backdrop-blur
                           border-black/10 dark:border-white/10 z-50"
                >
                    <div class="p-2 max-h-80 overflow-auto">
                        {familias.map((f) => (
                                <a
                                        href={`/familias/${f.slug}`}
                                        class="block rounded-xl px-3 py-2 text-sm
                                         hover:bg-black/5 dark:hover:bg-white/10
                                         focus:outline-none focus-visible:ring-2 focus-visible:ring-amarillonvm"
                                >
                                    {f.data.title}
                                </a>
                        ))}
                    </div>
                </div>
            </li>


            <li><a href="#contacto" class="hover:text-amarillonvm">Contacto</a></li>
        </ul>


        <div class="flex md:hidden items-center space-x-3">

            <button id="mobile-menu-btn" class="p-2 rounded border relative w-10 h-10 flex items-center justify-center" aria-label="Abrir menú">
                <svg id="icon-hamburger" class="w-6 h-6 absolute transition-all duration-300" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
                <svg id="icon-close" class="w-6 h-6 absolute opacity-0 scale-75 transition-all duration-300" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 6l12 12M6 18L18 6" />
                </svg>
            </button>
        </div>
    </nav>


    <div id="mobile-menu" class="md:hidden hidden bg-gray-50 border-t shadow-lg dark:bg-gray-900 dark:border-gray-700 z-10">
        <ul class="p-4 space-y-4 text-base">
            <li><a href="/" class="block">Inicio</a></li>
            <li><a href="#servicios" class="block">Servicios</a></li>
            <li><a href="#quienes-somos" class="block">Quiénes somos</a></li>
            <li>
                <details>
                    <summary class="cursor-pointer py-2 select-none">Portafolio</summary>
                    <div class="pl-4 space-y-2 mt-2">
                        {familias.map((f) => (
                                <a href={`/familias/${f.slug}`} class="block">{f.data.title}</a>
                        ))}
                    </div>
                </details>
            </li>
            <li><a href="#contacto" class="block">Contacto</a></li>
        </ul>
    </div>


    <script is:inline>
        (function () {

            const mobileBtn = document.getElementById('mobile-menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            const iconHamburger = document.getElementById('icon-hamburger');
            const iconClose = document.getElementById('icon-close');

            let mobileOpen = false;

            function setMobile(open) {
                mobileOpen = open;
                if (!mobileMenu) return;
                mobileMenu.classList.toggle('hidden', !mobileOpen);

                if (iconHamburger && iconClose) {
                    iconHamburger.classList.toggle('opacity-0', mobileOpen);
                    iconHamburger.classList.toggle('scale-75', mobileOpen);
                    iconClose.classList.toggle('opacity-0', !mobileOpen);
                    iconClose.classList.toggle('scale-75', !mobileOpen);
                }
            }

            if (mobileBtn && mobileMenu) {
                mobileBtn.addEventListener('click', () => setMobile(!mobileOpen));

                // Cerrar cuando se hace click en cualquier link del menú
                mobileMenu.addEventListener('click', (e) => {
                    const a = e.target && e.target.closest ? e.target.closest('a') : null;
                    if (a) setMobile(false);
                });
            }

            const famBtn = document.getElementById('desktop-familias-btn');
            const famMenu = document.getElementById('desktop-familias-menu');

            if (famBtn && famMenu) {
                const wrapper = famBtn.closest('li') || famBtn.parentElement;
                const canHover = window.matchMedia('(hover: hover) and (pointer: fine)').matches;

                let closeTimer = null;

                function openMenu() {
                    if (closeTimer) {
                        clearTimeout(closeTimer);
                        closeTimer = null;
                    }
                    famBtn.setAttribute('aria-expanded', 'true');
                    famMenu.classList.remove('hidden');
                }

                function closeMenuDelayed() {
                    if (closeTimer) clearTimeout(closeTimer);
                    closeTimer = setTimeout(() => {
                        famBtn.setAttribute('aria-expanded', 'false');
                        famMenu.classList.add('hidden');
                        closeTimer = null;
                    }, 150); // clave: tolera el "gap"
                }

                function closeMenuNow() {
                    if (closeTimer) {
                        clearTimeout(closeTimer);
                        closeTimer = null;
                    }
                    famBtn.setAttribute('aria-expanded', 'false');
                    famMenu.classList.add('hidden');
                }

                function toggleMenu() {
                    const expanded = famBtn.getAttribute('aria-expanded') === 'true';
                    expanded ? closeMenuNow() : openMenu();
                }

                // Cerrar al hacer click en un item del dropdown
                famMenu.addEventListener('click', (e) => {
                    const a = e.target && e.target.closest ? e.target.closest('a') : null;
                    if (a) closeMenuNow();
                });

                // Escape para cerrar
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') closeMenuNow();
                });

                if (canHover && wrapper) {

                    wrapper.addEventListener('mouseenter', openMenu);
                    wrapper.addEventListener('mouseleave', closeMenuDelayed);


                    famMenu.addEventListener('mouseenter', openMenu);
                    famMenu.addEventListener('mouseleave', closeMenuDelayed);


                    famBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        toggleMenu();
                    });
                } else {
                    famBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        toggleMenu();
                    });

                    document.addEventListener('click', (e) => {
                        if (!famMenu.contains(e.target) && !famBtn.contains(e.target)) closeMenuNow();
                    });
                }
            }


            const header = document.getElementById('site-header');
            let lastScroll = window.scrollY;
            let ticking = false;

            function handleScroll() {
                const current = window.scrollY;

                if (header) {
                    if (current > lastScroll && current > 50) {
                        header.style.transform = 'translateY(-100%)';

                        if (mobileOpen) setMobile(false);
                    } else {
                        header.style.transform = '';
                    }
                }

                lastScroll = current;
                ticking = false;
            }

            window.addEventListener('scroll', () => {
                if (!ticking) {
                    window.requestAnimationFrame(handleScroll);
                    ticking = true;
                }
            });
        })();
    </script>

</header>

